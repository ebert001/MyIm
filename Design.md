# Openfire中Domain的作用
Openfire通讯时会使用JID．JID的构成: **UserName** @ **Domain**. 例如：lizhou@im.wizarpos.com

在通讯时Openfire服务器会根据此domain进入路由，以确认用户所在的服务器，并将消息发送到对应的用户．

# MyIM
## 服务器架构
一(消息)中心多(连接)端点，多(消息)中心互联，多(连接)端点隔离

用户地址的构成元素: 端点地址(公网ip 或 局域网ip) + 中心地址(公网ip或局域网ip)

用户有单独的登录中心，专门进行登录工作．登录完成获取令牌，此令牌在各个端点通用.

端点 <--> 中心　的连接提供２中方式SSL和普通Socket连接，若使用SSL连接，双方自动协商证书和密钥信息
中心 <--> 中心　的连接提供２中方式SSL和普通Socket连接，若使用SSL连接，双方自动协商证书和密钥信息

用户和端点的连接使用普通的Socket连接，但是报文必须使用双方协商的绘画密钥进行加密．会话密钥的更新周期为一天或一次在线周期(在线时间超过一天)．

前置动作
* 用户登录
* 请求可用服务器列表(有优先级)

指令类型:
* PING
* 终端离线确认
* 点对点消息
* 点对面消息
* 在线状态
* 文件传输
* 文件私服
* 检索离线消息
* 用户签名检索信息
* 好友信息检索
* 好友上线信息检索
* 好友上下线通知



## 通讯报文格式定义 Length + Content
### Content格式定义
长度 + 指令 + 质量等级 + 用户 + 目标用户(可能是群组)(地址，类似openfire的domain，通过此地址可以精确的定位到用户连接的端点服务器) + 时间 + 内容
质量等级 0 广播式发送，不需要确认目标是否已经接收到
质量等级 1 目标对象需发送已接收到消息的反馈

目标用户如果带有地址信息，在用户离线并重新上线以后地址信息可能会发生变化

示例:
Ping
u-->s 0x03 + 0x01 + 0x01
s-->u 0x03 + 0x02 + 0x00

user message to user
u-->s 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE...
s-->m 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE... + 0xserverid
m-->s 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE... + 0xserverid + 0xmessageid
可乐观认为用户在线，若用户不再线应用将离线消息存储到离线表中
s-->u 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE... + 0xserverid + 0xmessageid + 0xserverid

