# Openfire中Domain的作用
Openfire通讯时会使用JID．JID的构成: **UserName** @ **Domain**. 例如：lizhou@im.wizarpos.com

在通讯时Openfire服务器会根据此domain进入路由，以确认用户所在的服务器，并将消息发送到对应的用户．

# MyIM
## 服务器架构
一(消息)中心多(连接)端点，多(消息)中心互联，多(连接)端点隔离．这种情况主要用在对网络环境有安全要求的用户，端点机相当于前置机．
中心即端点，直接接入互联网终端．这种情况适用在对环境要求不高的(小)用户．能安全正常使用即可．


用户地址的构成元素: 端点地址(公网ip 或 局域网ip) + 中心地址(公网ip或局域网ip)

用户有单独的登录中心，专门进行登录工作．登录完成获取令牌，此令牌在各个端点通用.

端点 <--> 中心　的连接提供 2 种方式SSL和普通Socket连接，若使用SSL连接，双方自动协商证书和密钥信息
中心 <--> 中心　的连接提供 2 种方式SSL和普通Socket连接，若使用SSL连接，双方自动协商证书和密钥信息
中心 <--> 中心 的消息流动应当是明文的，中心-->终端　或　终端-->中心　之间的数据流动是密文的．这就意味着消息在发出之前要进行加密操作，到达服务器之后需要进行解密操作，在准备出服务器时需要加密操作，在出服务器之后需要进行解密操作．

第一版本的功能中，默认实现中心即端点的方式．用户终端直接连接服务器，多服务器之间可以相互通讯．

用户和端点的连接使用普通的Socket连接，但是报文必须使用双方协商的会话密钥进行加密．会话密钥的更新周期为一天或一次在线周期(在线时间超过一天)．

前置动作
* 用户登录
* 请求可用服务器列表(有优先级)

指令类型:
* PING
* 终端离线确认
* 点对点消息
* 点对面消息
* 在线状态
* 文件传输
* 文件私服
* 检索离线消息
* 用户签名检索信息
* 好友信息检索
* 好友上线信息检索
* 好友上下线通知

#基本软件使用方案
##数据库存储Mysql
* 所有的基础用户数据
* 所有的离线数据

##数据高速访问和更新 Redis|Hazelcast
* 在线用户数据
* 在线服务器数据
* 用户通讯数据缓存

##基本数据安全

##基本数据流走向
+ 用户注册　　
> 用户注册的入口在IM的官方网站，或者api接口．这是新用户使用系统进行通讯的第一步．

+ 用户登录，用户登录是用户使用系统进行通讯的第二步．用户登录会做几件事情: <br/>
	1. 主动和服务器进行连接 <br/>
	2. 终端api计算本机指纹(可能是网卡或者硬盘id)，并利用此指纹生成公私钥对(可能发生的情况，如果一个终端上有多个用户使用本软件进行通讯，他们的加密方式是一样的) <br/>
	3. 上送终端机指纹，服务器会使用此指纹生成一套公私钥对，并把服务器公钥证书返还给终端 <br/>
	4. 用户输入登录名和密码 <br/>
	5. 终端程序使用服务器公钥对用户名和密码进行加密，并上送服务器 <br/>
	6. 服务器使用私钥进行解密，并对用户名和密码进行校验，确认是否登录成功 <br/>
	7. 如果登录成功，服务器需对用户名和终端指纹进行记录，方便用户下次登录时进行安全提示(类似QQ，如异地登录等) <br/>
	8. 登录成功，服务器主动生成通讯密钥，并使用终端公钥进行加密，信息返还终端 <br/>
	9. 后续终端和服务器所有的通讯报文都依赖通讯密钥进行加密. 加密方式:AES256 <br/>
	10. 登录应当开辟单独的登录接口，和用户通讯连接的接口分离． <br/>
+ 获取好友列表
	* 在用户登录完成以后，需要再次发送请求获取好友列表。 <br/>
	* 每个用户属性中都保存有好友列表的哈希（或者好友版本号），若哈希（版本号）不一致，终端应当重新获取好友列表。 <br/>
	* 哈希的计算应当分为多个维度进行：群组一个哈希，一个群组的好友一个哈希 <br/>
	* 哈希的计算方式：好友信息按照id进行排序，并计算md5值存储。 <br/>
	* 版本号的计算方式：从1开始顺序计算， <br/>
	
+ 用户发送消息 <br/>
	1. 	


##通讯报文
点对点报文
已送达的通讯报文不记录入库
未送达的通讯报文，记录入库．每个通讯报文都有自己的时间戳．返还给终端时需按时间进行升序排列

群组报文
每个群组都有当前报文使用的最大编号默认是0
每条报文都有自己的编号(从0开始)，已发送数量，以及当前群组的人员数量，以及过期时间．当已发送数量 等于 群组人员数量时，说明这条报文已经发送给了群组的所有用户，可以清理．否则，应当继续保留在离线库中
新加入群组的用户，直接获取当前最大的报文编号，并获取大于此编号的群组消息(小于此编号的为未加入前的历史消息，不可获取)

点对点离线报文和群组离线报文，应当在不同的表中存放．提高存放效率.

##报文元素分析
点对点通讯
发送人　接收人　发送时间　发送内容
群组通讯
发送人　接收群组　发送时间　发送内容

##发送图片，附件
发送图片和附件必须经过附件中转服务器．
发送的图片和附件需要在用户终端提取属性，并发送给目标终端．
若目标终端接收，用户终端计算出对应的hash，并上送到附件终端服务器，由服务器生成唯一token并返还给终端
终端收到唯一token以后发送给目标终端，目标终端进行下载操作，完成文件的接收操作．
若目标终端拒绝，则直接取消传输．


## 通讯报文格式定义 Length + Content
### Content格式定义
长度 + 指令 + 质量等级 + 用户 + 目标用户(可能是群组)(地址，类似openfire的domain，通过此地址可以精确的定位到用户连接的端点服务器) + 时间 + 内容　　
质量等级 0 广播式发送，不需要确认目标是否已经接收到　　
质量等级 1 目标对象需发送已接收到消息的反馈　　

目标用户如果带有地址信息，在用户离线并重新上线以后地址信息可能会发生变化　　

示例:
Ping
u-->s 0x03 + 0x01 + 0x01
s-->u 0x03 + 0x02 + 0x00

user message to user
u-->s 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE...
s-->m 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE... + 0xserverid
m-->s 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE... + 0xserverid + 0xmessageid
可乐观认为用户在线，若用户不再线应用将离线消息存储到离线表中
s-->u 0x10 + 0x03 + 0x01 + 0x0000000000000001 + 0x0000000000000002 + 0x1234567890123456 + 0x01 + 0xFE... + 0xserverid + 0xmessageid + 0xserverid

##指令定义
Ping					0x01
User Message			0x02
Group Message			0x03
File Message			0x04 | 0x05 | 0x06